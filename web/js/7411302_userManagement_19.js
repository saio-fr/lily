var lily;$(function(){function closeModelView(){this.model=undefined;this.$el.empty();this.stopListening();return this}function closeCollectionView(){this.model=undefined;this.$el.empty();this.stopListening();return this}$.ajaxPrefilter(function(options){options.url=root+options.url});lily=lily||{};lily.User=Backbone.Model.extend({getRolesHuman:function(roles){var roles=this.get("roles");if(typeof roles==="undefined")return"";var role_human="";if(roles.indexOf("ROLE_ADMIN")!==-1)role_human="Administrateur";else{if(roles.indexOf("ROLE_CHAT_OPERATOR")!==-1){role_human+="Opérateur Live chat"}if(roles.indexOf("ROLE_KNOWLEDGE_OPERATOR")!==-1){role_human+=role_human===""?"Opérateur ":" et ";role_human+="Base de connaissance"}}return role_human},getLastLoginHuman:function(){var last_login=this.get("last_login");if(typeof last_login!=="undefined"&&last_login!=null&&last_login.toUpperCase()!="NULL"){var d=new Date(last_login);return"Dernière connexion le "+(d.getDate()<10?"0":"")+d.getDate()+"/"+(d.getMonth()<9?"0":"")+(d.getMonth()+1)+"/"+(d.getYear()-100)}else{return"Jamais connecté"}},toJSONWithComputedValues:function(){var data=this.toJSON();data.last_login_human=this.getLastLoginHuman();data.roles_human=this.getRolesHuman();return data}});lily.ListUser=Backbone.Collection.extend({model:lily.User,sortCriteria:"lastname",comparator:function(item){if(this.sortCriteria==="lastname"){return item.get("lastname")}else if(this.sortCriteria==="roles"){var roles=item.get("roles");var rolesInt=0;if(roles.indexOf("ROLE_ADMIN")!==-1)rolesInt+=4;if(roles.indexOf("ROLE_KNOWLEDGE_OPERATOR")!==-1)rolesInt+=2;if(roles.indexOf("ROLE_CHAT_OPERATOR")!==-1)rolesInt+=1;return-rolesInt}else if(this.sortCriteria==="services"){return item.get("services").join("/")}else if(this.sortCriteria==="last_login"){return-item.get("last_login")||-Infinity}else{if(this.sortCriteria!=="id")console.warn("Sort criteria not recognized");return item.get("id")||"0"}return a}});lily.UserView=Backbone.View.extend({tagName:"li",className:"list-group-item hover",template:_.template($("#user").html()),setModel:function(model){if(this.model!==model){this.model=model;this.listenTo(this.model,"select",this.select);this.listenTo(this.model,"change",this.render);this.render()}return this},render:function(){this.$el.html(this.template(this.model.toJSONWithComputedValues()));return this},events:{"click .destroy":"destroy","click .edit":"edit","click .view":"view"},destroy:function(e){e.stopPropagation();(function(userView){bootbox.setDefaults({locale:"fr"});bootbox.dialog({title:"Attention !",message:"Vous allez supprimer un utilisateur, cette action est irréversible.<br /><br />Souhaitez vous continuer ?",buttons:{confirm:{label:"Supprimer l'utilisateur",className:"btn-delete",callback:function(){userView.model.url="/rest/"+userView.model.id;listUser.remove(userView.model);userView.model.destroy();userView.remove()}},cancel:{label:"Annuler",className:"btn-cancel"}}})})(this);return this},edit:function(e){e.preventDefault();e.stopPropagation();var id=$(e.currentTarget).parent().data("id");if(typeof userEditView==="undefined")userEditView=new lily.UserEditView;userEditView.setModel(this.model);this.$el.parent().find("li.active").removeClass("active");this.$el.addClass("active");return this},view:function(e){e.preventDefault();var userViewId=$(e.currentTarget).data("id");app.navigate("stats/"+userViewId+"/livechat",{trigger:true});return this},close:closeModelView});lily.ListUserView=Backbone.View.extend({el:"#user-list",initialize:function(listUser){this.collection=listUser;this.listenTo(listUser,"add",this.add);this.listenTo(listUser,"sort",this.updateView);this.render()},render:function(){if($(document).find(this.$el).length==0){this.$el=$(this.__proto__.el);this.delegateEvents()}this.$el.empty();this.collection.each(this.add,this);return this},add:function(user){var view=new lily.UserView;view.setModel(user);this.$el.append(view.render().el);return this},updateView:function(){this.$el.empty();this.render();return this},close:closeCollectionView});lily.UserEditView=Backbone.View.extend({el:"#user-detail",template:_.template($("#userEdit").html().replace(/<\\\/script/g,"</script")),setModel:function(model){if(this.model!==model){this.model=model;this.listenTo(this.model,"destroy",this.remove);this.render()}return this},events:{"click .button-update":"update","click .button-cancel":"cancel","change input":"checkIfValid","submit #user-editor":"noSubmit"},update:function(){$("form#user-editor").jsFormValidator("validate",{recursive:true});if($("form#user-editor")[0].jsFormValidator.isValid()){var classicInputs=$('form#user-editor input:not([type="checkbox"]):not([type="password"]):not([name="avatar"]');for(var i=0;i<classicInputs.length;i++){this.model.set(classicInputs.eq(i).attr("name"),classicInputs.eq(i).val())}var multipleChoicesInputs=$("form#user-editor .dropdownSelect");for(var i=0;i<multipleChoicesInputs.length;i++){var multipleValues=[];var multipleChoices=multipleChoicesInputs.eq(i).find(":checked");for(var j=0;j<multipleChoices.length;j++){multipleValues.push(multipleChoices.eq(j).attr("name"))}this.model.set(multipleChoicesInputs.eq(i).data("name"),multipleValues)}var avatarUrl=$("iframe#avatarWidget").contents().find("input#lily_userbundle_user_avatar").val();this.model.set("avatar",avatarUrl);var passwordInputFirst=$("#lily_userbundle_user_plainPassword_first");var passwordInputSecond=$("#lily_userbundle_user_plainPassword_second");this.model.set("plainPassword",{first:passwordInputFirst.val(),second:passwordInputSecond.val()});this.model.save();listUser.add(this.model);this.remove();$("#user-list .active").removeClass("active")}return this},cancel:function(){this.remove();$("#user-list .active").removeClass("active");return this},render:function(){if($(document).find(this.$el).length==0){this.$el=$(this.__proto__.el);this.delegateEvents()}userManagementAppView.editedUserId=this.model.id;this.$el.removeClass("hide");this.$el.html(this.template(this.model.toJSON()));$("iframe#avatarWidget").load(function(){$(".loader").hide()});return this},noSubmit:function(e){e.preventDefault();return this},checkIfValid:function(e){e.target.jsFormValidator.validate();return this},remove:function(){userManagementAppView.editedUserId=null;this.$el.addClass("hide");this.close()},close:closeModelView});lily.UserManagementApp=Backbone.Model.extend();lily.UserManagementAppView=Backbone.View.extend({el:"#users",template:_.template($("#userManagementAppViewTpl").html()),editedUserId:null,events:{"click .new-user":"createUser","click #sortMenu li":"changeSortCriteria"},initialize:function(){this.listenTo(listUser,"add",this.updateNumberOfUser);this.listenTo(listUser,"remove",this.updateNumberOfUser)},setModel:function(model){if(this.model!==model){this.model=model;this.render()}return this},render:function(){if($(document).find(this.$el).length==0){this.$el=$(this.__proto__.el);this.delegateEvents()}this.$el.removeClass("hide");this.$el.html(this.template(this.model.toJSON()));this.updateNumberOfUser();return this},createUser:function(e){e.preventDefault();if(typeof userEditView!=="undefined")userEditView.remove();user=new lily.User({avatar:"http://erwan.saio.fr/images/avatar-utilisateur.png"});if(typeof userEditView==="undefined")userEditView=new lily.UserEditView;userEditView.setModel(user);$("#user-list .active").removeClass("active");return this},changeSortCriteria:function(e){var target=$(e.target);if(target.data("criteria")!==undefined){listUser.sortCriteria=target.data("criteria");target.parent().find(".active").removeClass("active");target.addClass("active");listUser.sort();listUserView.updateView()}return this},updateNumberOfUser:function(){var maxUsers=this.model.get("maxusers");if(listUser.length>=maxUsers){$("#userListCounter").addClass("limitReached");$("#userMaxReachedAlert").show();$("#addUserButton").hide()}else{$("#userListCounter").removeClass("limitReached");$("#userMaxReachedAlert").hide();$("#addUserButton").show()}$("#userListCounter").text(listUser.length+(listUser.length<=1?" compte":" comptes")+" sur "+maxUsers+(maxUsers<=1?" disponible":" disponibles"));return this},close:closeModelView});lily.UserStatsApp=Backbone.Model.extend();lily.UserStatsAppView=Backbone.View.extend({el:"#users",template:_.template($("#userStatsAppViewTpl").html()),events:{"click .nav.nav-tabs li":"changeTab"},setModel:function(model){if(this.model!==model){this.model=model;this.render()}return this},render:function(){if($(document).find(this.$el).length==0){this.$el=$(this.__proto__.el);this.delegateEvents()}this.$el.removeClass("hide");this.$el.html(this.template(this.model.toJSON()));return this},changeTab:function(e){if($(e.currentTarget).find("a")){var tab=$(e.currentTarget).find("a").attr("href").substr(5);app.navigate("stats/"+this.model.get("userId")+"/"+tab,{trigger:true})}return this},close:closeModelView});lily.Data=Backbone.Model.extend();lily.UserStatsGraphView=Backbone.View.extend({el:"#graph",template:_.template($("#userStatsGraphTpl").html()),templateFooter:_.template($("#userStatsGraphFooterTpl").html()),events:{"click .numberOfConversation":"numberOfConversation","click .conversationTime":"conversationTime","click .waited":"waited","click .satisfaction":"satisfaction","hide #reportrange":"range"},setModel:function(model){console.log(this.el,this.$el);if(this.model!==model){this.model=model;if(typeof this.start=="undefined"){this.start=moment().subtract("days",30);this.end=moment()}this.render()}return this},render:function(){if($(document).find(this.$el).length==0){this.$el=$(this.__proto__.el);this.delegateEvents()}this.footer=new lily.Data;this.footer.url="/rest/userStats/footer/"+this.model.get("userId")+"/"+this.start+"/"+this.end;$(this.$el).find(".loader").fadeIn();that=this;this.footer.fetch({success:function(){that.$el.html(that.template());that.$el.append(that.templateFooter(that.footer.toJSON()));$(that.$el).find("footer").css({opacity:0});$("#reportrange").daterangepicker({ranges:{"Cette semaine":[moment().subtract("days",6),moment()],"Ce mois":[moment().subtract("days",30),moment()],"Ce semestre":[moment().subtract("month",4).startOf("month"),moment()],"Cette année":[moment().subtract("month",12),moment()]},startDate:moment().subtract("days",29),endDate:moment(),dateLimit:{months:36}},function(start,end){$("#reportrange span").html(start.format("D MMMM YYYY")+" - "+end.format("D MMMM YYYY"));that.start=start;that.end=end.add("days",1)});$("#reportrange span").html(that.start.format("D MMMM YYYY")+" - "+that.end.format("D MMMM YYYY"));that.numberOfConversation()}});return this},userStatsFooter:function(type){that=this;this.footer.url="/rest/userStats/footer/"+this.model.get("userId")+"/"+this.start+"/"+this.end;this.footer.fetch({success:function(data){that.$el.find("footer").remove();that.$el.append(that.templateFooter(that.footer.toJSON()));that.$el.find("footer ."+type).addClass("active")}});return this},numberOfConversation:function(){$(this.$el).find(".loader").removeClass("hide");data=new lily.Data;data.url="/rest/userStats/"+this.model.get("userId")+"/graph/numberOfConversation/"+this.start+"/"+this.end;$(this.$el).find("#graph-userStats").animate({opacity:0});$(this.$el).find(".loader").fadeIn();var that=this;data.fetch({success:function(data){$("#graph .active").removeClass("active");$(".numberOfConversation").addClass("active");that.graph(data);$(that.$el).find("#graph-userStats").animate({opacity:1});$(that.$el).find("footer").animate({opacity:1});$(that.$el).find(".loader").fadeOut()}});return this},conversationTime:function(){data=new lily.Data;data.url="/rest/userStats/"+this.model.get("userId")+"/graph/conversationTime/"+this.start+"/"+this.end;$(this.$el).find("#graph-userStats").animate({opacity:0});$(this.$el).find(".loader").fadeIn();var that=this;data.fetch({success:function(data){$("#graph .active").removeClass("active");$(".conversationTime").addClass("active");$(that.$el).find("#graph-userStats").animate({opacity:0});that.graph(data);$(that.$el).find("#graph-userStats").animate({opacity:1});$(that.$el).find("footer").animate({opacity:1});$(that.$el).find(".loader").fadeOut()}});return this},waited:function(){data=new lily.Data;data.url="/rest/userStats/"+this.model.get("userId")+"/graph/waited/"+this.start+"/"+this.end;$(this.$el).find("#graph-userStats").animate({opacity:0});$(this.$el).find(".loader").fadeIn();var that=this;data.fetch({success:function(data){$("#graph .active").removeClass("active");$(".waited").addClass("active");$(that.$el).find("#graph-userStats").animate({opacity:0});that.graph(data);$(that.$el).find("#graph-userStats").animate({opacity:1});$(that.$el).find("footer").animate({opacity:1});$(that.$el).find(".loader").fadeOut()}});return this},satisfaction:function(){data=new lily.Data;data.url="/rest/userStats/"+this.model.get("userId")+"/graph/satisfaction/"+this.start+"/"+this.end;$(this.$el).find("#graph-userStats").animate({opacity:0});$(this.$el).find(".loader").fadeIn();var that=this;data.fetch({success:function(data){$("#graph .active").removeClass("active");$(".satisfaction").addClass("active");$(that.$el).find("#graph-userStats").animate({opacity:0});that.graph(data);$(that.$el).find("#graph-userStats").animate({opacity:1});$(that.$el).find("footer").animate({opacity:1});$(that.$el).find(".loader").fadeOut()}});return this},range:function(){if(this.$el.find(".active").hasClass("numberOfConversation")){this.numberOfConversation();this.userStatsFooter("numberOfConversation")}if(this.$el.find(".active").hasClass("conversationTime")){this.conversationTime();this.userStatsFooter("conversationTime")}if(this.$el.find(".active").hasClass("waited")){this.waited();this.userStatsFooter("waited")}if(this.$el.find(".active").hasClass("satisfaction")){this.satisfaction();this.userStatsFooter("satisfaction")}return this},graph:function(data){d1=[];var i=0;while(typeof data.attributes.values[i]!="undefined"){d1.push([data.attributes.values[i][0],data.attributes.values[i][1]]);i++}function getTooltip(label,x,y){var value;switch(data.attributes.type){case"numberOfConversation":value=parseFloat(y).toFixed(2);break;case"conversationTime":value=parseInt(y/60)+" min "+parseInt(y%60)+" s";break;case"waited":value=parseInt(y/60)+" min "+parseInt(y%60)+" s";break;case"satisfaction":value=parseInt(y*100)+"%";break;default:console.warn("Data type not recognized in getTooltip : "+type);break}if(data.attributes.period=="hour"){var date=moment(x/1e3,"X").format("HH");return value+" à "+date+" heures"}if(data.attributes.period=="day"){var date=moment(x/1e3,"X").format("DD/MM/YYYY");return value+" le "+date}if(data.attributes.period=="month"){var date=moment(x/1e3,"X").format("MMMM");return value+" en "+date}}function yAxisTickFormatter(y,axis){var value;switch(data.attributes.type){case"numberOfConversation":value=parseFloat(y);break;case"conversationTime":value=parseInt(y/60)+" min "+parseInt(y%60)+" s";break;case"waited":value=parseInt(y/60)+" min "+parseInt(y%60)+" s";break;case"satisfaction":value=parseInt(y*100)+"%";break;default:console.warn("Data type not recognized in yAxisTickFormatter : "+type)}return value}var plotOptions={series:{lines:{show:true,lineWidth:2,fill:true,fillColor:{colors:[{opacity:0},{opacity:.2}]}},points:{radius:5,show:true},shadowSize:2},grid:{color:"#fff",hoverable:true,clickable:true,tickColor:"#f0f0f0",borderWidth:0},colors:["#5dcff3"],xaxis:{min:d1[d1.length-1][0],max:d1[0][0],mode:"time",tickSize:[data.attributes.step,data.attributes.period],tickLength:0,monthNames:["janvier","février","mars","avril","mai","juin","juillet","août","septembre","octobre","novembre","décembre"],dayNames:["Lun","Mar","Mer","Jeu","Ven","Sam","Dim"]},yaxis:{min:0,ticks:2,tickDecimals:0,tickFormatter:yAxisTickFormatter},tooltip:true,tooltipOpts:{content:getTooltip,defaultTheme:false,shifts:{x:0,y:20}}};if(data.attributes.type=="satisfaction"){plotOptions.yaxis.max=1;plotOptions.yaxis.tickSize=.5}if(data.attributes.type=="hourly"){plotOptions.xaxis.timeformat="%H:%M"}else{plotOptions.xaxis.timeformat="%d %b"}var plot=$.plot($("#graph-userStats"),[{data:d1}],plotOptions);return this},close:closeModelView});lily.Conversation=Backbone.Model.extend({getStartTimeHuman:function(){var startTime=this.get("startTime");if(typeof startTime!=="undefined"){var d=new Date(startTime*1e3);return(d.getDate()<10?"0":"")+d.getDate()+"/"+(d.getMonth()<9?"0":"")+(d.getMonth()+1)+"/"+(d.getYear()-100)}else return""},getDurationHuman:function(){var duration=this.get("endTime")-this.get("startTime");return parseInt(duration/60)+" min"},toJSONWithComputedValues:function(){var data=this.toJSON();data.startTime_human=this.getStartTimeHuman();data.duration_human=this.getDurationHuman();return data}});lily.ConversationView=Backbone.View.extend({tagName:"li",className:"list-group-item hover",template:_.template($("#conversationTpl").html()),events:{"click .view":"view"},setModel:function(model){if(this.model!==model){this.model=model;this.render()}return this},render:function(){this.$el.html(this.template(this.model.toJSONWithComputedValues()));return this},view:function(e){e.preventDefault();var conversationDetailsId=$(e.currentTarget).data("id");conversationDetails=new lily.ConversationDetails;conversationDetails.url="/rest/conversationHistory/conversation/"+conversationDetailsId;conversationDetails.fetch({success:function(){conversationDetailsView=new lily.ConversationDetailsView(conversationDetails);conversationDetailsView.setModel(conversationDetails)}});this.$el.parent().find("li.active").removeClass("active");this.$el.addClass("active");$("#conversationDetails").show();return this}});lily.ConversationList=Backbone.Collection.extend({model:lily.Conversation,sortCriteria:"startTime",comparator:function(item){if(this.sortCriteria==="redirect"){redirect=item.get("redirect");if(!redirect)return"";else return listUser._byId[redirect].get("lastname")}else if(this.sortCriteria==="duration")return item.get("startTime")-item.get("endTime");else return item.get(this.sortCriteria)}});lily.ConversationDetails=Backbone.Model.extend({getStartTimeDateFullText:function(){var startTime=this.get("startTime");var monthNames=["janvier","février","mars","avril","mai","juin","juillet","août","septembre","octobre","novembre","décembre"];if(typeof startTime!=="undefined"){var d=new Date(startTime*1e3);return d.getDate()+" "+monthNames[d.getMonth()]+" "+d.getFullYear()}else return""},formatMessagesDate:function(){var messages=this.get("messages");for(var i=0,l=messages.length;i<l;i++){var d=new Date(messages[i].time*1e3);messages[i].time_human=(d.getHours()<10?"0":"")+d.getHours()+":"+(d.getMinutes()<10?"0":"")+d.getMinutes()}return messages},toJSONWithComputedValues:function(){var data=this.toJSON();data.startTime_date_fullText=this.getStartTimeDateFullText();data.messages=this.formatMessagesDate();return data}});lily.ConversationDetailsView=Backbone.View.extend({el:"#conversationDetails",template:_.template($("#conversationDetailsTpl").html().replace(/<\\\/script/g,"</script")),setModel:function(model){if(this.model!==model){this.model=model;this.render()}return this},render:function(){if($(document).find(this.$el).length==0){this.$el=$(this.__proto__.el);this.delegateEvents()}userStatsAppView.viewedConversationId=this.model.id;this.$el.removeClass("hide");this.$el.html(this.template(this.model.toJSONWithComputedValues()));return this},close:closeModelView});lily.ConversationHistoryView=Backbone.View.extend({el:"#conversationHistory",template:_.template($("#conversationHistoryTpl").html()),events:{"click #conversationHistory-menu ul li":"changeSortCriteria"},initialize:function(){this.listenTo(conversationHistory,"sort",this.updateView)},setCollection:function(collection){if(this.collection!==collection){this.collection=collection;this.render()}return this},render:function(){if($(document).find(this.$el).length==0){this.$el=$(this.__proto__.el);this.delegateEvents()}this.$el.empty();this.$el.html(this.template());this.collection.each(this.add,this);return this},add:function(conversation){var view=new lily.ConversationView({model:conversation});this.$el.find("ul#conversationHistory-list").append(view.render().el);return this},updateView:function(){this.render();return this},changeSortCriteria:function(e){var target=$(e.target);if(target.data("criteria")!==undefined){conversationHistory.sortCriteria=target.data("criteria");console.log(target);target.parent().find(".active").removeClass("active");target.addClass("active");conversationHistory.sort();conversationHistoryView.updateView()}return this},close:closeCollectionView});lily.Question=Backbone.Model.extend();lily.QuestionView=Backbone.View.extend({tagName:"li",className:"list-group-item hover",template:_.template($("#questionTpl").html()),events:{"click .view":"view"},setModel:function(model){if(this.model!==model){this.model=model;this.render()}return this},render:function(){this.$el.html(this.template(this.model.toJSON()));return this},view:function(e){e.preventDefault();var questionDetailsId=$(e.currentTarget).data("id");questionDetails=new lily.ConversationDetails;questionDetails.url="/rest/knowledgeBase/question/"+questionDetailsId;questionDetails.fetch({success:function(){questionDetailsView=new lily.QuestionDetailsView(questionDetails)}});this.$el.parent().find("li.active").removeClass("active");this.$el.addClass("active");$("#questionDetails").show();return this}});lily.QuestionList=Backbone.Collection.extend({model:lily.Question,sortCriteria:"startTime",comparator:function(item){if(this.sortCriteria==="redirect"){redirect=item.get("redirect");if(redirect===false)return"";else return listUser._byId[redirect].get("lastname")}else if(this.sortCriteria==="duration")return item.get("startTime")-item.get("endTime");else return item.get(this.sortCriteria)}});lily.QuestionDetails=Backbone.Model.extend();lily.QuestionDetailsView=Backbone.View.extend({el:"#questionDetails",template:_.template($("#questionDetailsTpl").html().replace(/<\\\/script/g,"</script")),setModel:function(model){if(this.model!==model){this.model=model;this.render()}return this},render:function(){if($(document).find(this.$el).length==0){this.$el=$(this.__proto__.el);this.delegateEvents()}userStatsAppView.viewedQuestionId=this.model.id;this.$el.removeClass("hide");this.$el.html(this.template(this.model.toJSON()));return this},close:closeModelView});lily.KnowledgeBaseHistoryView=Backbone.View.extend({el:"#knowledgeBaseHistory",template:_.template($("#knowledgeBaseHistoryTpl").html()),events:{"click #knowledgeBaseHistory-menu ul li":"changeSortCriteria"},initialize:function(){this.listenTo(knowledgeBaseHistory,"sort",this.updateView)},setCollection:function(collection){if(this.collection!==collection){this.collection=collection;this.render()}return this},render:function(){if($(document).find(this.$el).length==0){this.$el=$(this.__proto__.el);this.delegateEvents()}this.$el.empty();this.$el.html(this.template());this.collection.each(this.add,this);return this},add:function(question){var view=new lily.QuestionView({model:question});this.$el.find("ul#knowledgeBaseHistory-list").append(view.render().el);return this},updateView:function(){this.render();return this},changeSortCriteria:function(e){var target=$(e.target);if(target.data("criteria")!==undefined){knowledgeBaseHistory.sortCriteria=target.data("criteria");console.log(target);target.parent().find(".active").removeClass("active");target.addClass("active");knowledgeBaseHistory.sort();knowledgeBaseHistoryView.updateView()}return this},close:closeCollectionView});AppRouter=Backbone.Router.extend({routes:{"":"home","stats/:id/:tab":"viewUserStats","*path":"home"},initialize:function(){listUser=new lily.ListUser;listUser.url="/rest/";listUserLoader=listUser.fetch()},home:function(){userManagementApp=new lily.UserManagementApp;userManagementApp.url="/rest/maxusers";userManagementApp.fetch({success:function(){listUserLoader.success(function(){if(typeof userManagementAppView==="undefined")userManagementAppView=new lily.UserManagementAppView;userManagementAppView.setModel(userManagementApp);listUserView=new lily.ListUserView(listUser)})}})},viewUserStats:function(id,tab){userStatsApp=new lily.UserStatsApp({userId:id});listUserLoader.success(function(){if(typeof userStatsAppView==="undefined")userStatsAppView=new lily.UserStatsAppView;userStatsAppView.setModel(userStatsApp);$('#userManagementContent .nav-tabs a[href="#tab-'+tab+'"]').tab("show")});switch(tab){case"livechat":userData=new lily.Data({userId:id});listUserLoader.success(function(){if(typeof userStatsGraphView==="undefined")userStatsGraphView=new lily.UserStatsGraphView;userStatsGraphView.setModel(userData)});break;case"conversationHistory":conversationHistory=new lily.ConversationList;conversationHistory.url="/rest/conversationHistory/"+id;conversationHistory.fetch({success:function(){listUserLoader.success(function(){if(typeof conversationHistoryView=="undefined")conversationHistoryView=new lily.ConversationHistoryView;conversationHistoryView.setCollection(conversationHistory)})}});break;case"knowledgeBase":knowledgeBaseHistory=new lily.QuestionList;knowledgeBaseHistory.url="/rest/knowledgeBase/"+id;knowledgeBaseHistory.fetch({success:function(){listUserLoader.success(function(){if(typeof knowledgeBaseHistoryView=="undefined")knowledgeBaseHistoryView=new lily.KnowledgeBaseHistoryView;knowledgeBaseHistoryView.setCollection(knowledgeBaseHistory)})}});break;default:console.warn("tab not recognized in viewUserStats");break}}});var app=new AppRouter;Backbone.history.start()});