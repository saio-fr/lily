lily.CategoryView=Backbone.View.extend({model:lily.Category,template:_.template($("#item-category").html()),tagName:"li",className:"wrapper-category ",render:function(){this.$el.html(this.template(this.model.toJSON()));return this},initialize:function(){this.children=this.model.get("children")},events:{"click .display-category":"changeCategory","click .categorie-delete":"deleteCategory","click .category-item-list":"filter","click .lily-icon-arrow-down":"showSubCategories","click .lily-icon-arrow-up":"showSubCategories"},changeCategory:function(e){if(typeof popupCategoryView=="undefined"){popupCategoryView=new lily.PopupCategoryView({model:this.model})}else{if(this.model.id==popupCategoryView.model.id){popupCategoryView.undelegateEvents();popupCategoryView.$el.empty();popupCategoryView.$el.addClass("hide");delete popupCategoryView}else{popupCategoryView.undelegateEvents();popupCategoryView.$el.empty();popupCategoryView=new lily.PopupCategoryView({model:this.model})}}},filter:function(e){var that=this;console.log("filter");var idCategory=this.model.id;if(app.postRequest.categories[0]==null){app.postRequest.categories[0]=idCategory;var m=0;var listChildren=this.model.get("children");_.each(listChildren,function(){app.postRequest.categories.push(listChildren.models[m].id);m++});$("#list-categories").find("i.display-category").addClass("undisplayed");$(e.currentTarget).parent().children("i.display-category").removeClass("undisplayed");$(e.currentTarget).parent().parent().find("i.display-category").removeClass("undisplayed")}else{var initial_length=app.postRequest.categories.length;var l=0;_.each(app.postRequest.categories,function(){if(idCategory==app.postRequest.categories[l]){app.postRequest.categories.splice(l,1);$(e.currentTarget).parent().children("i.display-category").addClass("undisplayed");var listChildren=that.model.get("children");console.log(listChildren+"listChildren");var m=0;_.each(listChildren,function(){console.log(app.postRequest.categories.indexOf(listChildren.models[m]));app.postRequest.categories.splice(app.postRequest.categories.indexOf(listChildren.models[m].id),1);m++})}l++});if(app.postRequest.categories.length=="0"){app.postRequest.categories.push(null);$("#list-categories").find(".display-category").removeClass("undisplayed");$(e.currentTarget).parent().parent().find("i.display-category").removeClass("undisplayed")}else if(initial_length==app.postRequest.categories.length){app.postRequest.categories.push(idCategory);$(e.currentTarget).parent().children("i.display-category").removeClass("undisplayed");$(e.currentTarget).parent().parent().find("i.display-category").removeClass("undisplayed");var m=0;var listChildren=this.model.get("children");_.each(listChildren,function(){if(app.postRequest.categories.indexOf(listChildren.models[m].id)<0){app.postRequest.categories.push(listChildren.models[m].id)}m++})}}app.postRequest.trigger("refresh")},deleteCategory:function(){listCategories.remove(this.model);this.model.url="/categories/delete/"+this.model.id;Backbone.sync("delete",this.model);$("#list-categories").children().remove();new lily.listCategoriesView(listCategories)},showSubCategories:function(e){console.log("showSubCategories");if($(e.currentTarget).parent().children("ul.list-sub-categories").attr("class").search("hide")>0){$(e.currentTarget).parent().children("ul.list-sub-categories").removeClass("hide");$(e.currentTarget).parent().children("i.lily-icon-arrow-down").removeClass("text").addClass("text-active");$(e.currentTarget).parent().children("i.lily-icon-arrow-up").removeClass("text-active").addClass("text")}else{$(e.currentTarget).parent().children("i.lily-icon-arrow-up").removeClass("text").addClass("text-active");$(e.currentTarget).parent().children("i.lily-icon-arrow-down").removeClass("text-active").addClass("text");$(e.currentTarget).parent().children("ul.list-sub-categories").addClass("hide")}var listSubCategories=new lily.ListCategories;listSubCategories=this.children.clone();if(typeof this.listSubCategoriesView=="undefined"){this.listSubCategoriesView=new lily.ListSubCategoriesView($(e.currentTarget).parent().children("ul"),listSubCategories)}}});