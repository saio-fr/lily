chat.Views.Conversation=Backbone.View.extend({tagName:"section",className:"vbox animated fadeInRight",events:{"click .conversation-close":"close","click .conversation-minus":"minus","click .ban":"ban","click .conversation-form button.send":"send","click .conversation-form .icon-trash":"clearInput"},initialize:function(){that=this;this.messages=new chat.Messages;this.listenTo(this.model,"change:messages",this.getMessages);this.listenTo(this.messages,"add",this.addItem);this.listenTo(this.messages,"add",this.status);this.listenTo(this.model,"urgent",this.urgent);this.listenTo(this.model,"change:banned",this.remove);this.listenTo(this.model,"change:closed",this.remove);this.listenTo(this.model,"change:writing",this.writing);this.listenTo(this.model,"render",this.active);this.active();$(this.render().el).prependTo(".conversations");this.$input=this.$el.find("textarea");this.editor=new wysihtml5.Editor(that.$el.find("textarea").get(0),{toolbar:that.$el.find(".toolbar").get(0),parserRules:wysihtml5ParserRules,useLineBreaks:true});this.getMessages();this.$writing=this.$el.find(".alert-writing")},render:function(){var template=_.template($("#conversation").html());this.$el.html(template(this.model.toJSON()));$("input, textarea").placeholder();return Backbone.View.prototype.render.apply(this,arguments)},getMessages:function(){this.messages.set(this.model.get("messages"))},sendOnEnter:function(e){if(e.keyCode==13&&!e.shiftKey){this.send()}},send:function(){this.message=this.editor.getValue();if($.trim(this.message).length>0){sess.publish("visitor/"+this.model.id,this.message)}this.clearInput()},addItem:function(message){var index=this.messages.indexOf(message);var messageAbove=this.messages.at(index-1);var date=new moment(message.date);if(index>=1){var dateAbove=new moment(messageAbove.date);if(date.month()!==dateAbove.month()||date.day()!==dateAbove.day()){$('<p class="conversation-date">Conversation du '+date.format("DD MMMM YYYY")+"</p>").appendTo(this.$el.find(".conversation-section-list"))}}else{$('<p class="conversation-date">Conversation du '+date.format("DD MMMM YYYY")+"</p>").appendTo(this.$el.find(".conversation-section-list"))}switch(message.get("from")){case"operator":new chat.Views.MessageOperator({model:message}).render(this.$el.find(".conversation-section-list"));this.$el.find(".status").removeClass("text-urgent");break;case"visitor":new chat.Views.MessageVisitor({model:message}).render(this.$el.find(".conversation-section-list"));break}this.$el.find(".conversation-section").scrollTop(1e4)},clearInput:function(){this.editor.clear()},minus:function(){that=this;this.$el.addClass("fadeOutDown");setTimeout(function(){that.remove()},200);this.model.trigger("minus");chat.app.windows.splice($.inArray(this,chat.app.windows),1);chat.app.trigger("change:windows")},close:function(){new chat.Views.ModalClose;that=this;$(".modal-close-confirm").click(function(){chat.app.windows.splice($.inArray(that,chat.app.windows),1);chat.app.trigger("change:windows");sess.call("chat/close",{sid:that.model.get("id")});chat.app.live.counter.current-=1;$(".header-current span").html(chat.app.live.counter.current)})},ban:function(){new chat.Views.ModalBan;that=this;$(".modal-ban-confirm").click(function(){chat.app.windows.splice($.inArray(that,chat.app.windows),1);chat.app.trigger("change:windows");sess.call("chat/ban",{sid:that.model.get("id")});chat.app.live.counter.current-=1;$(".header-current span").html(chat.app.live.counter.current)})},urgent:function(){this.$el.find(".status").addClass("text-urgent")},active:function(){this.model.trigger("active")},status:function(){if(this.messages.at(this.messages.length-1).get("from")=="visitor"){this.$el.find(".status").removeClass("text-answered").addClass("text-unanswered")}else{this.$el.find(".status").removeClass("text-unanswered").addClass("text-answered")}},writing:function(){if(this.model.get("writing")){this.$writing.removeClass("fadeOut").addClass("fadeIn");this.$writing.show()}else{this.$writing.removeClass("fadeIn").addClass("fadeOut")}}});