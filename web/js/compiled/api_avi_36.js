lily.Views.Avi=lily.Extensions.View.extend({mood:"",messageModel:"",messageType:"",events:{"submit #lily-search-form":"doSearch","click #lily-go":"doSearch"},initialize:function(){this.$input=this.$("#lily-search-form input.lily-search-input");this.listenTo(this,"render",this.avatar);lily.Events.on("precision",this.sendPrecision,this);lily.Events.on("satisfied",this.sendNotation,this);lily.Events.on("notSatisfied",this.sendNotation,this);lily.Events.on("redirectionTel",this.sendRedirectionTel,this);lily.Events.on("redirectionMail",this.sendRedirectionMail,this);$(this.render().el).appendTo("#lily-wrapper-page")},render:function(){var template=_.template($("#lily-page-avi-template").html());this.$el.html(template());this.trigger("render");$("input, textarea").placeholder();return lily.Extensions.View.prototype.render.apply(this,arguments)},doSearch:function(e){e.preventDefault();this.$input=this.$el.find("#lily-search-form input.lily-search-input");var query=this.$input.val();if($.trim(query).length>0){this.search(query);var messageModel=new lily.Models.MessageUserSimple({message_content:this.$input.val()});this.addItem(messageModel,"user-simple");this.showLoading()}this.clearInput()},search:function(q){var avi=this;lily.ws.call("chat/newAviQuestion",{question:q});$.ajax({type:"POST",url:root+"/query",data:{query:q},success:function(data,textStatus,request){var type=request.getResponseHeader("type");avi.clearLoading();if(!data){this.trigger("emptySearch")}if(type==="insult"){var messageModel=new lily.Models.MessageLilySimple({message_content:data});var messageType="lily-simple";avi.mood="angry";avi.addItem(messageModel,messageType)}if(type==="answer"){var messageModel=new lily.Models.MessageLilySimple({message_content:data.answer});var messageType="lily-simple";avi.addItem(messageModel,messageType);var messageModel=new lily.Models.MessageLilyNotation({id:data.id});var messageType="lily-notation";avi.mood=data.mood;avi.addItem(messageModel,messageType)}if(type==="personal"){var messageModel=new lily.Models.MessageLilySimple({message_content:data.answer});var messageType="lily-simple";avi.mood=data.mood;avi.addItem(messageModel,messageType)}if(type==="misunderstood"){var messageModel=new lily.Models.MessageLilySimple({message_content:"Désolé, je n'ai pas compris votre question."});var messageType="lily-simple";avi.addItem(messageModel,messageType);if(data.isMail||data.isTel||data.isChat){var messageModel=new lily.Models.MessageLilyRedirection({data:data});var messageType="lily-redirection";avi.mood="sceptical";avi.addItem(messageModel,messageType)}}if(type==="precision"){var messageModel=new lily.Models.MessageLilyPrecision({actions:data.actions,precision:data.parent.answer,idparent:data.parent.id});var messageType="lily-precision";avi.mood=data.mood;avi.addItem(messageModel,messageType)}}})},sendPrecision:function(id,idparent,parent){var avi=this;$.ajax({url:root+"/precision/"+id,data:id,success:function(data,textStatus,request){console.log(data);var type=request.getResponseHeader("type");console.log(type);avi.clearLoading();if(!data){this.trigger("emptySearch");avi.clearLoading()}if(type==="answer"){var messageModel=new lily.Models.MessageLilySimple({message_content:data.answer});var messageType="lily-simple";avi.addItem(messageModel,messageType);var messageModel=new lily.Models.MessageLilyNotation({id:idparent});var messageType="lily-notation";avi.addItem(messageModel,messageType)}}})},sendRedirectionMail:function(id){var id=id;$.ajax({type:"POST",url:root+"/logredirection/"+id,data:JSON.stringify({canal:"mail"}),success:function(data){console.log("Log sent")}})},sendRedirectionTel:function(id){var id=id;$.ajax({type:"POST",url:root+"/logredirection/"+id,data:JSON.stringify({canal:"tel"}),success:function(data){console.log("Log sent")}})},sendNotation:function(id,satisfied,reason,view){var avi=this;var id=id;$.ajax({type:"POST",url:root+"/notation/"+id,data:JSON.stringify({satisfied:satisfied,reason:reason}),success:function(data,textStatus,request){if(satisfied==true){var messageModel=new lily.Models.MessageLilySimple({message_content:"Merci pour votre réponse! N'hesitez pas à me poser d'autres questions"});var messageType="lily-simple"}else{var messageModel=new lily.Models.MessageLilyRedirection({data:data});var messageType="lily-redirection"}avi.addItem(messageModel,messageType);view.remove()}})},addItem:function(messageModel,messageType){switch(messageType){case"user-simple":var message=new lily.Views.MessageUserSimple({model:messageModel}).render();break;case"lily-simple":var message=new lily.Views.MessageLilySimple({model:messageModel}).render();break;case"lily-redirection":var message=new lily.Views.MessageLilyRedirection({model:messageModel}).render();break;case"lily-precision":var message=new lily.Views.MessageLilyPrecision({model:messageModel}).render();break;case"lily-notation":var message=new lily.Views.MessageLilyNotation({model:messageModel}).render();break;case"lily-completion":var message=new lily.Views.MessageLilyCompletion({model:messageModel}).render();break}},showLoading:function(){this.$("#lily-box-messages").append('<div class="lily-msg-avatar lily-cst-msg-avatar lily-message-show"><p class="lily-loading"><span></span><span></span><span></span></p><i class="lily-avatar-bubble"></i></div>')},clearInput:function(){if(isMobile.phone){this.$input.val("").blur()}else this.$input.val("")},clearLoading:function(){if(this.$(".lily-loading").length){setTimeout(function(){this.$(".lily-loading").parent().fadeOut(function(){$(this).remove()})},500)}},emptySearch:function(){this.clearLoading();var model=new lily.Models.MessageLilySimple({message_content:"Il semblerait qu'il y ait un problème. Je n'ai pas trouvé de réponse à votre question"});this.message=new lily.Views.MessageLilySimple({model:model}).render()},avatar:function(){avi=this;setTimeout(function(){$.getScript(root+"/avatar",function(data){})},500)}});